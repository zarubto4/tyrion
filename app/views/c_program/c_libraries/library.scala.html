@import models.Model_Library

@(library: Model_Library)

<section class="content-header">
    <h1> @library.name </h1>
    <ol class="breadcrumb">
        <li><a href="@routes.Controller_Dashboard.index()"><i class="fa fa-globe"></i> Dashboard </a></li>
        <li class="active"><i class="fa fa-share"></i> Server Management </li>
        <li class="active"><i class="fa fa-wrench"></i> C Program Management </li>
        <li><a href="@routes.Controller_Dashboard.public_libraries()"><i class="fa fa-wrench"></i> Libraries </a></li>
        <li class="active"><i class="fa fa-wrench"></i> @library.name </li>
    </ol>
</section>

<!-- CONTENT -->

<section class="content">
        <div class="row">
            <div class="col-md-5">
                <div class="box">
                    <div class="box-header with-border">
                        <h3 class="box-title">Library details (ID = @library.id)</h3>
                        <div class="btn-group pull-right">
                            <button class="btn btn-xs btn-danger" type="button" onclick="removeLibrary()" title="Remove Library"><i class="fa fa-times"></i></button>
                            <button class="btn btn-xs btn-info" type="button" data-toggle="modal" data-target="#editLibraryModal" title="Edit Library"><i class="fa fa-edit"></i></button>
                        </div>
                    </div>
                    <div class="box-body">
                        <label for="types_of_boards">Types of boards</label>
                        <div id="types_of_boards" class="form-group">
                            @for(typeOfBoard <- library.type_of_boards) {

                                <span class="label label-primary">@typeOfBoard.name</span>

                            }
                        </div>
                        <label for="library_description">Description</label>
                        <textarea id="library_description" class="form-group form-control" readonly rows="3">@library.description</textarea>
                    </div>
                </div>
                <div class="box">
                    <div class="box-header with-border">
                        <h3 class="box-title">Versions</h3>
                    </div>
                    <div class="box-body" id="versionsWrapper">
                        <table id="versions" class="table table-bordered" >
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @for(version <- library.versions){
                                    <tr>
                                        <td>@version.version_name @if(version.removed_by_user){ <span class="label label-danger">deleted</span> }</td>
                                        <td>@version.version_description</td>
                                        <td><button class="btn btn-xs btn-block btn-info" type="button" onclick="getVersion('@version.id')" title="Open"><i class="fa fa-wrench"></i></button></td>
                                        <td><button class="btn btn-xs btn-block btn-danger" type="button" onclick="deleteVersion('@version.id')" title="Delete"><i class="fa fa-times"></i></button></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">Version details</h3>
                            <div class="btn-group pull-right">
                                <button id="deleteVersionButton" class="btn btn-xs btn-danger disabled" type="button" onclick="deleteVersion()" title="Delete"><i class="fa fa-times"></i></button>
                                <button id="editVersionButton" class="btn btn-xs btn-info disabled" type="button" data-toggle="modal" data-target="#editVersionModal" title="Edit" onclick="fillEditVersionForm()"><i class="fa fa-edit"></i></button>
                                <button class="btn btn-xs btn-success pull-right" type="button" data-toggle="modal" data-target="#newVersionModal" onclick="newVersion()" title="Save new version"><i class="fa fa-plus"></i></button>
                            </div>
                        </div>
                        <div class="box-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="version_id">ID</label>
                                    <input id="version_id" class="form-control form-group" type="text" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="version_name">Name</label>
                                    <input id="version_name" class="form-control form-group" type="text" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label>Author</label>
                                    <div class="clearfix"></div>
                                    <a id="author" title="Open author" onclick="author()"></a>
                                </div>
                            </div>
                            <label for="version_description">Description</label>
                            <textarea id="version_description" class="form-group form-control" rows="3" readonly></textarea>
                        </div>
                    </div>
                <div class="row">
                    <div class="col-md-4">
                         <div class="box">
                             <div class="box-header with-border">
                                 <h3 class="box-title">Examples</h3>
                                 <button id="newExampleButton" class="btn btn-xs btn-success disabled pull-right" disabled type="button" data-toggle="modal" data-target="#newExampleModal" title="New Example"><i class="fa fa-plus"></i></button>
                             </div>
                             <div class="box-body">
                                 <div id="examples">
                                 </div>
                             </div>
                             <div class="box-footer">
                             </div>
                         </div>
                         <div class="box">
                             <div class="box-header with-border">
                                 <h3 class="box-title">Files</h3>
                                 <button id="newFileButton" class="btn btn-xs btn-success pull-right" type="button" data-toggle="modal" data-target="#newFileModal" title="New File"><i class="fa fa-plus"></i></button>
                             </div>
                             <div class="box-body">
                                 <div class="nav nav-sidebar" id="files">
                                 </div>
                             </div>
                             <div class="box-footer">
                             </div>
                         </div>
                    </div>
                    <div class="col-md-8">
                        <div class="box">
                            <div class="box-header with-border">
                                <h3 class="box-title">Code Editor</h3>
                            </div>
                            <div class="box-body">
                                <div id="editor"></div>
                            </div>
                            <div class="box-footer">
                                <p class="pull-left" id="file_name"></p>
                                <button id="saveFileButton" disabled class="btn btn-xs btn-success pull-right disabled" type="button" onclick="saveFile()">Save file</button>
                                <!-- <button id="saveExampleButton" disabled class="btn btn-success pull-right disabled" type="button" style="margin-right: 10px;" onclick="saveExample()">Save example</button> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</section>

<!-- NEW VERSION MODAL -->

<div id="newVersionModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="newVersionModalTitle">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="newVersionModalTitle" class="modal-title">New Version</h4>
            </div>
            <div class="modal-body">
                <p>Type in new information.</p>
                <form id="newVersion">
                    <input class="form-control form-group" title="Name" type="text" id="new_version_name" >
                    <input class="form-control form-group" title="Description" type="text" id="new_version_description" >
                </form>
                <div id="newVersionModalMessage" style="display: none"><p class="text-red"></p></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default pull-left" type="button" data-dismiss="modal">Close</button>
                <button class="btn btn-success" type="button" onclick="saveVersion()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- EDIT VERSION MODAL -->

<div id="editVersionModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="editVersionModalTitle">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="editVersionModalTitle" class="modal-title">Edit Library Version</h4>
            </div>
            <div class="modal-body">
                <form id="editVersion">
                    <input id="edit_version_name" class="form-control form-group" title="Name" type="text" name="version_name">
                    <input id="edit_version_description" class="form-control form-group" title="Description" type="text" name="version_description">
                </form>
                <div id="editVersionModalMessage" style="display: none"><p class="text-red"></p></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default pull-left" type="button" data-dismiss="modal">Close</button>
                <button class="btn btn-success" type="button" onclick="editVersion()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- NEW EXAMPLE MODAL -->

<div id="newExampleModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="newExampleModalTitle">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="newExampleModalTitle" class="modal-title">New Example</h4>
            </div>
            <div class="modal-body">
                <form id="newExample">
                    <div style="float: left; width: 30%;">
                        <label>Name</label>
                        <input id="newExampleName" placeholder="Name" style="display: block" type="text" name="version_name" >
                    </div>
                    <div style="width: 100%;">
                        <label>Description</label>
                        <input id="newExampleDescription" placeholder="Description" style="display: block; width: 70%;" type="text" name="version_description" >
                    </div>
                </form>
                <div id="newExampleModalMessage" style="display: none"><p class="text-red"></p></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default pull-left" type="button" data-dismiss="modal">Close</button>
                <button class="btn btn-success" type="button" onclick="newExample()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- EDIT LIBRARY MODAL -->

<div id="editLibraryModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="editLibraryModalTitle">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="editLibraryModalTitle" class="modal-title">Edit Library</h4>
            </div>
            <div class="modal-body">
                <form id="editLibrary">
                    <input class="form-control form-group" title="Name" type="text" name="name" value="@library.name">
                    <input class="form-control form-group" title="Description" type="text" name="description" value="@library.description">
                </form>
                <div id="editLibraryModalMessage" style="display: none"><p class="text-red"></p></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default pull-left" type="button" data-dismiss="modal">Close</button>
                <button class="btn btn-success" type="button" onclick="editLibrary()">Save</button>
            </div>
        </div>
    </div>
</div>

<div id="newFileModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="newFileModalTitle">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="newFileModalTitle" class="modal-title">New File</h4>
            </div>
            <div class="modal-body">
                <form id="newFile">
                    <label>Name</label>
                    <p class="text-red">Specify the full path (e.g. "library/folder/file.cpp")</p>
                    <input id="newFileName" placeholder="Name" style="display: block" type="text" name="file_name" >
                </form>
                <div id="newFileModalMessage" style="display: none"><p class="text-red"></p></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default pull-left" type="button" data-dismiss="modal">Close</button>
                <button class="btn btn-success" type="button" onclick="newFile()">Create</button>
            </div>
        </div>
    </div>
</div>

<script>

    $.ajaxSetup({ cache: false });

    var id = "@library.id";
    var editor;
    var files;
    var examples;

    var openedVersion = {
        version_id:"",
        version_name:"",
        version_description:"",
        files:[],
        examples:[]
    };
    var openedFile;

    function makeId() {
        var text = "";
        var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

        for( var i=0; i < 5; i++ )
            text += possible.charAt(Math.floor(Math.random() * possible.length));

        return text;
    }

    function makeJson(data){

        var tree = [];
        var root = 0;

        function fillTree(content, steps, x) {
            var current = null,
                    existing = null,
                    i = 0;
            for (var y = 0; y < steps.length; y++) {

                if (y == 0) {

                    if (!tree[root] || !tree[root].children || typeof tree[root].children == 'undefined') {
                        tree[root] = {text: steps[y], leaf: false, children: []};
                    }

                    for (var z = 0; z < tree.length; z++) {
                        if (tree[z].text !== steps[y] && z == (tree.length - 1)){
                            tree.push({text: steps[y], leaf: false, children: []});
                            root = z + 1;
                            break;
                        }
                        if (tree[z].text === steps[y]){
                            root = z;
                            break;
                        }
                    }

                    current = tree[root].children;
                } else {
                    existing = null;
                    for (i = 0; i < current.length; i++) {
                        if (current[i].text === steps[y]) {
                            existing = current[i];
                            break;
                        }
                    }
                    if (existing) {
                        current = existing.children;
                    } else {
                        current.push({text: steps[y], leaf: false, children: []});
                        current = current[current.length - 1].children;
                    }
                }
            }
            current.push({text: content, leaf: true, order: x})
        }

        for (x = 0; x < data.length; x++) {
            steps = data[x].file_name.split('/');
            fillTree(data[x].content, steps, x)
        }

        return tree;
    }

    function makeTree(t) {

        var content = "<ul style='list-style-type: none; margin: 0; padding: 0;'>";

        if (t.leaf != true) {
            if (t.children.length == 1 && t.children[0].leaf == true) {
                content += "<li style='margin: 0; padding: 0;'>" +
                        "<div class='panel-group' style='margin: 5px 0;' id='" + t.text + "'>" +
                        "<div class='panel panel-default'>" +
                        "<div class='panel-heading' style='padding: 5px 10px;'>" +
                        "<h4 class='panel-title'>" +
                        "<a onclick=\"" +
                        "openFile(" + t.children[0].order + ");" +
                        "\">";

                content += t.text;

                content += "</a><button class='btn btn-xs btn-danger pull-right' type='button' onclick='removeFile(" + t.children[0].order + ")' title='Remove File' style='top: -2px; position: relative;'><i class='fa fa-times'></i></button></h4></div>" +
                        "<div id='collapse" + t.text + "' class='panel-collapse collapse'>" +
                        "<div class='panel-body' style='padding: 0 5px 0 10px;'>";
            } else {
                var randomId = makeId();
                content += "<li style='margin: 0; padding: 0;'>" +
                        "<div class='panel-group' style='margin: 5px 0;' id='" + t.text + "'>" +
                        "<div class='panel panel-default'>" +
                        "<div class='panel-heading' style='padding: 5px 10px;'>" +
                        "<h4 class='panel-title'>" +
                        "<a style='display:block;' data-toggle='collapse' data-parent='#" + t.text + randomId + "' href='#collapse" + t.text + randomId + "'>" + t.text + "</a></h4></div>" +
                        "<div id='collapse" + t.text + randomId + "' class='panel-collapse collapse'>" +
                        "<div class='panel-body' style='padding: 0 5px 0 10px;'>";
            }
            $.each(t.children, function (k, v) {
                content += makeTree(v);
            });
            content += "</div></div></div></div></li>";
        }

        content += "</ul>";

        return content;
    }

    function makeStructure(trees){

        var content = "";

        $.each(trees, function (k, v) {
            content += makeTree(v)
        });

        return content;
    }

    function editLibrary(){
        model_data = $("#editLibrary").serializeObject();
        $.ajax({
            url: '@routes.Controller_Library.library_update("")' + openedLibrary.id,
            type: 'PUT',
            contentType: 'application/json',
            headers: {
                "X-AUTH-TOKEN":getCookie("authToken"),
                "Content-Type":"application/json"
            },
            data: JSON.stringify(model_data),
            dataType: 'json',
            success:function(json){
                location.reload();
            },
            error:function(e) {
                $("#editLibraryModalMessage").css("display", "block");
                $("#editLibraryModalMessage p").text(JSON.parse(e.responseText).message);
                $("#editLibraryModalMessage p").append(JSON.stringify(JSON.parse(e.responseText).exception));
            }
        })
    }

    function newVersion(){

        $("#new_version_name").val(openedVersion.version_name);
        $("#new_version_description").val(openedVersion.version_description);
    }

    function getVersion(version_id) {
       $.ajax({
           url: '/library/version/' + version_id,
           type: 'GET',
           headers: {
               "X-AUTH-TOKEN":getCookie("authToken")
           },
           dataType: 'json',
           success:function(json){
               openVersion(json);
           },
           error:function(e) {
               alert(JSON.stringify(JSON.parse(e.responseText).message));
           }
       })
    }

    function editVersion(){
        $.ajax({
            url: '@routes.Controller_Library.libraryVersion_update("")' + openedVersion.version_id,
            type: 'PUT',
            contentType: 'application/json',
            headers: {
                "X-AUTH-TOKEN":getCookie("authToken"),
                "Content-Type":"application/json"
            },
            data: JSON.stringify($("#editVersion").serializeObject()),
            dataType: 'json',
            success:function(json){
                $("#editVersionModal").modal('hide');
                $('#versionsWrapper').load(document.URL +  ' #versions');
                openVersion(json);
            },
            error:function(e) {
                $("#editVersionModalMessage").css("display", "block");
                $("#editVersionModalMessage p").text(JSON.parse(e.responseText).message).append(JSON.stringify(JSON.parse(e.responseText).exception));
            }
        })
    }

    function saveVersion() {

        openedVersion.id = null;
        openedVersion.version_name = $("#new_version_name").val();
        openedVersion.version_description = $("#new_version_description").val();

        $.ajax({
            url: '/library/version/' + id,
            type: 'POST',
            contentType: 'application/json',
            headers: {
                "X-AUTH-TOKEN":getCookie("authToken"),
                "Content-Type":"application/json"
            },
            dataType: 'json',
            data: JSON.stringify(openedVersion),
            success:function(json){
                $("#newVersionModal").modal('hide');

                //var newRow = "<tr><td>" + json.version_name + "</td><td>" + json.version_description + "</td>";
                //newRow += "<td><button class=\"btn btn-xs btn-block btn-info\" type=\"button\" onclick=\"getVersion('" + json.version_id + "')\" title=\"Edit\"><i class=\"fa fa-wrench\"></i></button></td>";
                //newRow += "<td><button class=\"btn btn-xs btn-block btn-danger\" type=\"button\" onclick=\"deleteVersion('" + json.version_id +"')\" title=\"Delete\"><i class=\"fa fa-times\"></i></button></td></tr>";

                //$("#versions tbody").prepend(newRow);
                $('#versionsWrapper').load(document.URL +  ' #versions');
                openVersion(json);
            },
            error:function(e) {
                $("#newVersionModalMessage").css("display", "block");
                $("#newVersionModalMessage p").text(JSON.parse(e.responseText).message).append(JSON.stringify(JSON.parse(e.responseText).exception));
            }
        })
    }

    function deleteVersion(version_id){

        if (typeof version_id == "undefined") version_id = openedVersion.version_id;

        $.ajax({
            url: '@routes.Controller_Library.libraryVersion_delete("")' + version_id,
            type: 'DELETE',
            headers: {
                "X-AUTH-TOKEN":getCookie("authToken")
            },
            dataType: 'json',
            success:function(json){
                location.reload();
            },
            error:function(e) {
                alert(JSON.stringify(JSON.parse(e.responseText).message));
            }
        })
    }

    function openVersion(json) {

        $("#version_id").val(json.version_id);
        $("#version_name").val(json.version_name);
        $("#version_description").text(json.version_description);
        $("#author").text(json.author.nick_name + " <" + json.author.mail + ">");

        $('#deleteVersionButton').prop('disabled', false).removeClass('disabled');
        $('#editVersionButton').prop('disabled', false).removeClass('disabled');

        openedVersion = json;

        closeFile();

        if (json.files.length > 0) {
            $('#files').html(makeStructure(makeJson(json.files)));
        }else{
            $('#files').html("<p>No files here! Hit the plus button to add o new one.</p>");
        }

        if (json.examples.length > 0) {

            examples = json.examples;

            $.each(examples, function (k, v) {

                var content = "";

                content += "<ul style='list-style-type: none; padding: 0;'><li style='margin: 0; padding: 0;'>" +
                        "<div class='panel-group' style='margin: 5px 0;'>" +
                        "<div class='panel panel-default'>" +
                        "<div class='panel-heading' style='padding: 5px 10px;'>" +
                        "<h4 class='panel-title'>" +
                        "<a onclick=\"" +
                        "openExample(" + k + ");" +
                        "\">";
                content += v.name;

                content += "</a><button class='btn btn-xs btn-danger pull-right' type='button' onclick='removeExample(" + k + ")' title='Remove Example'><i class='fa fa-times'></i></button></h4></div>" +
                        "<div class='panel-collapse collapse'>" +
                        "<div class='panel-body' style='padding: 0 5px 0 10px;'>";
                content += "</div></div></div></div></li></ul>";

                $('#examples').html(content);
            });


        }else{
            $('#examples').html("<p>No examples here! Hit the plus button to add o new one.</p>");
        }
    }

    function newFile(){
        openedFile = {file_name: $('#newFileName').val(), content: ''};
        $('#file_name').text(openedFile.file_name);
        editor.setValue("// your new file - " + openedFile.file_name,1);
        $("#newFileModal").modal('hide');
        $('#newFileName').val("");

        $('#saveFileButton').prop('disabled', false).removeClass('disabled');
        //$('#saveExampleButton').prop('disabled', true).addClass('disabled');
    }

    function saveFile(){
        openedFile.content = editor.getValue();
        if (openedVersion.files.length == 0){
            openedVersion.files.push(openedFile);
        } else {
            $.each(openedVersion.files,function (k, v) {
                if(openedFile.file_name === v.file_name){
                    openedVersion.files[k].content = openedFile.content;
                    return false;
                } else if (k == openedVersion.files.length - 1){
                    openedVersion.files.push(openedFile);
                }
            });
        }

        $('#files').html(makeStructure(makeJson(openedVersion.files)));
    }

    function openFile(order){

        $('#file_name').text(openedVersion.files[order].file_name);

        openedFile = openedVersion.files[order];

        var content = openedVersion.files[order].content;

        editor.setValue(content, 1);

        $('#saveFileButton').prop('disabled', false).removeClass('disabled');
        $('#saveExampleButton').prop('disabled', true).addClass('disabled');
    }

    function closeFile() {
        $('#saveFileButton').prop('disabled', true).addClass('disabled');
        //$('#saveExampleButton').prop('disabled', true).addClass('disabled');

        $('#file_name').text("");
        editor.setValue("");
    }

    function removeFile(order){

        openedVersion.files.splice(order,1);
        $('#files').html(makeStructure(makeJson(openedVersion.files)));
    }

    function fillEditVersionForm() {
        $("#edit_version_name").val(openedVersion.version_name);
        $("#edit_version_description").val(openedVersion.version_description);
    }

    function author() {
        location.href = "/admin/helpdesk_tool?email=" + openedVersion.author.mail;
    }

    $(function(){
        editor = ace.edit("editor");
        //editor.setTheme("ace/theme/eclipse");
        editor.getSession().setMode("ace/mode/c_cpp");
    });
</script>